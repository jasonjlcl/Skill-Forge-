services:
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-genai_onboarding}
    volumes:
      # Persistent Postgres data volume.
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-genai_onboarding}']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  chroma:
    image: chromadb/chroma:0.5.15
    restart: unless-stopped
    environment:
      IS_PERSISTENT: 'TRUE'
      CHROMA_SERVER_HOST: 0.0.0.0
      CHROMA_SERVER_HTTP_PORT: 8000
      PERSIST_DIRECTORY: /chroma/chroma
    volumes:
      # Persistent Chroma vector data volume.
      - chroma_data:/chroma/chroma
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'python -c "import urllib.request; urllib.request.urlopen(\"http://localhost:8000/api/v1/heartbeat\")"',
        ]
      interval: 10s
      timeout: 5s
      retries: 8
      start_period: 15s

  migrate:
    build:
      context: .
      dockerfile: server/Dockerfile
      target: build
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/genai_onboarding}
    depends_on:
      postgres:
        condition: service_healthy
    command: ['npm', 'run', 'migrate']
    restart: 'no'

  api:
    build:
      context: .
      dockerfile: server/Dockerfile
      target: runner
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 4000
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/genai_onboarding}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-genai_onboarding}
      JWT_SECRET: ${JWT_SECRET:-change-me-in-production}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      CHROMA_URL: ${CHROMA_URL:-http://chroma:8000}
      CHROMA_COLLECTION: ${CHROMA_COLLECTION:-training_documents}
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-200}
      REQUEST_BODY_LIMIT: ${REQUEST_BODY_LIMIT:-2mb}
      COOKIE_SECURE: ${COOKIE_SECURE:-true}
      SHUTDOWN_TIMEOUT_MS: ${SHUTDOWN_TIMEOUT_MS:-15000}
    depends_on:
      migrate:
        condition: service_completed_successfully
      chroma:
        condition: service_healthy
    expose:
      - '4000'
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'node -e "fetch(\"http://localhost:4000/api/health\").then((r)=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"',
        ]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 20s

  web:
    build:
      context: .
      dockerfile: infra/nginx/Dockerfile
      args:
        VITE_API_BASE: ${VITE_API_BASE:-/api}
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    ports:
      - '${WEB_HTTP_PORT:-80}:80'

volumes:
  postgres_data:
  chroma_data:
