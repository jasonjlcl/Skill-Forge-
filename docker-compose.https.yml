services:
  web:
    environment:
      ENABLE_TLS: ${ENABLE_TLS:-false}
      DOMAIN_NAME: ${DOMAIN_NAME:-app.example.com}
      TLS_CERT_PATH: ${TLS_CERT_PATH:-/etc/letsencrypt/live/app.example.com/fullchain.pem}
      TLS_KEY_PATH: ${TLS_KEY_PATH:-/etc/letsencrypt/live/app.example.com/privkey.pem}
    ports:
      - '${WEB_HTTPS_PORT:-443}:443'
    volumes:
      - certbot_conf:/etc/letsencrypt:ro
      - certbot_www:/var/www/certbot:ro

  certbot:
    image: certbot/certbot:latest
    profiles: ['tls']
    volumes:
      - certbot_conf:/etc/letsencrypt
      - certbot_www:/var/www/certbot
    entrypoint: /bin/sh
    command:
      [
        '-c',
        "trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot --quiet; sleep 12h; done",
      ]
    depends_on:
      - web

volumes:
  certbot_conf:
  certbot_www:
